{% extends "layout.html" %}

{% block title %}Contacto - Freire FPV{% endblock %}

{% block nav_contacto %}active{% endblock %}

{% block footer_question %}¿Tienes alguna pregunta que no encuentres aquí?{% endblock %}

{% block head_extra %}
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<link href="{{ url_for('static', filename='css/weather.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1>Contacta conmigo</h1>
        <p>Estoy a tu disposición para cualquier consulta o proyecto</p>
    </div>
</section>

<section class="contact-section">
    <div class="container">
        <div class="contact-content">
            <div class="contact-info animate-on-scroll">
                <h2>Información de Contacto</h2>
                <div class="info-item">
                    <i class="fas fa-phone"></i>
                    <div>
                        <h3>Teléfono</h3>
                        <p>+34 685788325</p>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-envelope"></i>
                    <div>
                        <h3>Email</h3>
                        <p>carlosfreire777@gmail.com</p>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <div>
                        <h3>Ubicación</h3>
                        <p>Málaga Capital, España</p>
                        <p>Opero en toda la Costa del Sol</p>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <div>
                        <h3>Horario</h3>
                        <p><strong>Verano:</strong> Lunes a Sábados: 8:00 - 21:00</p>
                        <p><strong>Invierno:</strong> Lunes a Viernes: 8:00 - 18:00</p>
                        <p><strong>Fin de Semanas:</strong> Con aviso previo</p>
                        <p><strong>Festivos:</strong> Con aviso previo</p>
                    </div>
                </div>
                <div class="social-links">
                    <a href="https://www.instagram.com/cpf.pv/" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="https://www.youtube.com/@CarlosFreire" target="_blank" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                    <a href="https://x.com/CarlosFreire0" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                </div>
            </div>
            
            <div class="contact-form animate-on-scroll">
                <h2>Envíame un mensaje</h2>
                <form id="contact-form">
                    <div class="form-group">
                        <label for="nombre-contacto">Nombre</label>
                        <input type="text" id="nombre-contacto" name="nombre-contacto" placeholder="Tu nombre completo" required>
                    </div>
                    <div class="form-group">
                        <label for="email-contacto">Email</label>
                        <input type="email" id="email-contacto" name="email-contacto" placeholder="tucorreo@ejemplo.com" required>
                    </div>
                    <div class="form-group">
                        <label for="telefono-contacto">Teléfono</label>
                        <input type="tel" id="telefono-contacto" name="telefono-contacto" placeholder="+34 XXX XXX XXX" required>
                    </div>
                    <div class="form-group">
                        <label for="asunto">Asunto</label>
                        <input type="text" id="asunto" name="asunto" placeholder="Motivo de tu consulta" required>
                    </div>
                    <div class="form-group">
                        <label for="mensaje-contacto">Mensaje</label>
                        <textarea id="mensaje-contacto" name="mensaje-contacto" placeholder="Explícame tu proyecto o consulta" required></textarea>
                    </div>
                    <button type="submit" id="contacto-submit-btn" class="btn-primary contacto-submit-btn"><span>Enviar Mensaje</span></button>
                </form>
            </div>
        </div>
    </div>
</section>

<section class="map-section">
    <div class="container">
        <h2 class="section-title">Área de Servicio</h2>
        <div class="map-wrapper animate-on-scroll">
            <div id="map">
                <!-- Mapbox map will be rendered here -->
            </div>
            <div class="service-areas">
                <h3>Zonas de Servicio</h3>
                <ul>
                    <li>Málaga Capital</li>
                    <li>Marbella</li>
                    <li>Fuengirola</li>
                    <li>Benalmádena</li>
                    <li>Torremolinos</li>
                    <li>Nerja</li>
                    <li>Estepona</li>
                    <li>Ronda</li>
                    <li>Rincón de la Victoria</li>
                    <li>Antequera</li>
                    <li>Y toda la Costa del Sol</li>
                </ul>
            </div>
            
            <!-- Sección del Tiempo -->
            <div class="weather-card">
                <h3>Previsión Meteorológica - Málaga</h3>
                <div class="weather-info">
                    {% if weather_data %}
                        <!-- Tiempo Actual -->
                        {% if weather_data.current %}
                            <div class="current-weather">
                                <div class="current-weather-header">
                                    <h4>Condiciones Actuales</h4>
                                    <div class="current-time">{{ weather_data.current.formatted_time }}</div>
                                </div>
                                
                                <div class="current-weather-main">
                                    <div class="current-icon">
                                        <img src="https://openweathermap.org/img/wn/{{ weather_data.current.icon }}@4x.png" alt="{{ weather_data.current.description }}">
                                    </div>
                                    <div class="current-temp-container">
                                        <div class="current-temp">{{ weather_data.current.temp }}°C</div>
                                        <div class="current-desc">{{ weather_data.current.description }}</div>
                                    </div>
                                </div>
                                
                                <div class="current-weather-details">
                                    <div class="current-detail">
                                        <div class="current-detail-title">Viento</div>
                                        <div class="current-detail-value">
                                            <i class="fas fa-wind"></i> {{ weather_data.current.wind }} km/h
                                        </div>
                                    </div>
                                    
                                    <div class="current-detail">
                                        <div class="current-detail-title">Humedad</div>
                                        <div class="current-detail-value">
                                            <i class="fas fa-tint"></i> {{ weather_data.current.humidity }}%
                                        </div>
                                    </div>
                                    
                                    <div class="current-detail">
                                        <div class="current-detail-title">Índice UV</div>
                                        <div class="current-detail-value">
                                            <i class="fas fa-sun"></i> {{ weather_data.current.uvi|round(1) }}
                                        </div>
                                    </div>
                                    
                                    <div class="current-detail">
                                        <div class="current-detail-title">Presión</div>
                                        <div class="current-detail-value">
                                            <i class="fas fa-tachometer-alt"></i> {{ weather_data.current.pressure }} hPa
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="current-flight-status current-status-{{ weather_data.current.flight_status }}">
                                    <i class="fas {% if weather_data.current.flight_status == 'optimal' %}fa-check-circle{% elif weather_data.current.flight_status == 'possible' %}fa-exclamation-triangle{% elif weather_data.current.flight_status == 'caution' %}fa-exclamation-circle{% else %}fa-times-circle{% endif %}"></i>
                                    {{ weather_data.current.status_text }}
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Pronóstico de 5 días -->
                        <div style="margin: 10px 0; border-bottom: 1px solid var(--color-light-gray); padding-bottom: 5px;">
                            <h4 style="font-size: var(--font-size-md); margin: 0;">Pronóstico de 5 días</h4>
                        </div>
                        <div class="weather-forecast">
                            {% for day in weather_data.daily %}
                                <div class="weather-day flight-status-{{ day.flight_status }}">
                                    <div class="day-name">{{ day.day_name }}</div>
                                    <div class="day-date">{{ day.date }}</div>
                                    <div class="weather-icon">
                                        <img src="https://openweathermap.org/img/wn/{{ day.icon }}@2x.png" alt="{{ day.description }}">
                                    </div>
                                    <div class="weather-temp">{{ day.temp }}°C</div>
                                    <div class="weather-desc">{{ day.description }}</div>
                                    <div class="weather-details">
                                        <span><i class="fas fa-wind"></i> {{ day.wind }} km/h</span>
                                        <span><i class="fas fa-tint"></i> {{ day.humidity }}%</span>
                                        {% if day.rain_amount > 0 %}
                                            <span class="rain-amount"><i class="fas fa-cloud-rain"></i> {{ day.rain_amount|round(1) }} mm</span>
                                        {% endif %}
                                    </div>
                                    <div class="weather-warning {% if day.flight_status == 'optimal' %}status-optimal{% elif day.flight_status == 'possible' %}status-possible{% elif day.flight_status == 'caution' %}status-caution{% else %}status-not-recommended{% endif %}">
                                        <i class="fas {% if day.flight_status == 'optimal' %}fa-check-circle{% elif day.flight_status == 'possible' %}fa-exclamation-triangle{% elif day.flight_status == 'caution' %}fa-exclamation-circle{% else %}fa-times-circle{% endif %}"></i>
                                        {% if day.flight_status == 'optimal' %}
                                            Óptimo para vuelos
                                        {% elif day.flight_status == 'possible' %}
                                            Posible con precaución
                                        {% elif day.flight_status == 'caution' %}
                                            Por determinar situación
                                        {% else %}
                                            No operable
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="weather-refresh">
                            <button id="refresh-weather" class="btn-secondary btn-icon">
                                <i class="fas fa-sync-alt"></i> Actualizar datos
                            </button>
                            <div class="weather-updated">
                                <small>Última actualización: <span id="weather-time">{{ weather_data.current.formatted_time }}</span></small>
                            </div>
                        </div>
                    {% else %}
                        <div class="weather-error">
                            <p>No se han podido cargar los datos meteorológicos.</p>
                            <button id="refresh-weather" class="btn-secondary btn-icon">
                                <i class="fas fa-sync-alt"></i> Intentar de nuevo
                            </button>
                        </div>
                    {% endif %}
                </div>
                
                
            </div>
            
            <!-- Tarjeta separada con información sobre políticas meteorológicas (mismo ancho que Zonas de Servicio) -->
            <div class="service-areas">
                <div class="weather-policy-info">
                    <h4>Información sobre Condiciones Meteorológicas</h4>
                    <p>El vuelo de drones está altamente condicionado por la meteorología. En Freire FPV nos preocupamos por ofrecer un servicio de calidad y seguro:</p>
                    <ul>
                        <li>Los vuelos requieren condiciones óptimas: cielos despejados/parcialmente nublados y vientos menores a 15 km/h.</li>
                        <li>Con vientos de 15-30 km/h, evaluamos la posibilidad de vuelo según el modelo de dron y tipo de grabación.</li>
                        <li>No operamos con lluvia o vientos superiores a 30 km/h por seguridad del equipo y calidad del resultado.</li>
                    </ul>
                    <p><strong>Política de reprogramación:</strong> Si el día de la sesión las condiciones meteorológicas impiden el vuelo, se reprogramará para la fecha más próxima posible según la predicción de la Agencia Estatal de Meteorología (AEMET) sin coste adicional.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="faq-section">
    <div class="container">
        <h2 class="section-title">Preguntas Frecuentes</h2>
        <div class="accordion">
            <div class="accordion-item">
                <div class="accordion-header">
                    <h3>¿Qué es un drone FPV y en qué se diferencia de los drones normales?</h3>
                    <span class="accordion-icon">+</span>
                </div>
                <div class="accordion-content">
                    <p>Los drones FPV (First Person View) son drones que se pilotean mediante gafas que muestran la visión en primera persona desde la cámara del drone. Esto permite un control más preciso y la capacidad de realizar maniobras más complejas y dinámicas que los drones tradicionales, resultando en grabaciones con movimientos cinematográficos únicos.</p>
                </div>
            </div>
            <div class="accordion-item">
                <div class="accordion-header">
                    <h3>¿Cuánto tiempo tarda la entrega de un proyecto finalizado?</h3>
                    <span class="accordion-icon">+</span>
                </div>
                <div class="accordion-content">
                    <p>El tiempo de entrega de cada proyecto es de unos 2-7 días, dependiendo del volumen de trabajo actual. Para proyectos estándar, suelo entregar los vídeos editados en 2-4 días hábiles. Para proyectos más complejos o con ediciones más elaboradas, puede tomar hasta 5-7 días. Siempre acordamos los plazos antes de iniciar el trabajo y me comprometo a mantener informado al cliente sobre el progreso del proyecto.</p>
                </div>
            </div>
            <div class="accordion-item">
                <div class="accordion-header">
                    <h3>¿Se necesitan permisos especiales para grabar con drones?</h3>
                    <span class="accordion-icon">+</span>
                </div>
                <div class="accordion-content">
                    <p>Sí, en España la operación de drones está regulada por la Agencia Estatal de Seguridad Aérea (AESA). Poseo las debidas licencias de AESA A1/A2 A3 y STS ES, y su debido aviso al Ministerio del Interior por cada operación. Para ciertas ubicaciones (como zonas urbanas o cerca de aeropuertos) pueden requerirse permisos adicionales que gestiono según cada proyecto, garantizando siempre el cumplimiento normativo.</p>
                </div>
            </div>
            <div class="accordion-item">
                <div class="accordion-header">
                    <h3>¿Qué formato de archivo recibiré con las grabaciones?</h3>
                    <span class="accordion-icon">+</span>
                </div>
                <div class="accordion-content">
                    <p>Recibirás las grabaciones en formato RAW y MP4 adaptado para redes sociales o como el cliente prefiera. Los videos se entregan en alta definición (1080p o 4K según lo acordado) y pueden ser optimizados para diferentes plataformas como Instagram, YouTube o para uso profesional. Si necesitas otro formato específico, puedo adaptarlo a tus requerimientos particulares.</p>
                </div>
            </div>
            <div class="accordion-item">
                <div class="accordion-header">
                    <h3>¿Se pueden realizar grabaciones en interiores?</h3>
                    <span class="accordion-icon">+</span>
                </div>
                <div class="accordion-content">
                    <p>¡Absolutamente! Es totalmente legítimo grabar en un espacio interior privado, respetando las normas comunes. Los drones FPV son especialmente útiles para estas grabaciones gracias a su tamaño compacto y maniobrabilidad excepcional. Son perfectos para recorridos dinámicos dentro de propiedades, edificios o espacios donde los drones convencionales no podrían volar, permitiendo capturar tomas únicas y fluidas que impresionarán a cualquier audiencia.</p>
                </div>
            </div>
        </div>
    </div>
</section>


{% endblock %}

{% block styles %}
<style>
    .cta-section.cta-secondary {
        background: #f8f9fa;
        margin-top: 2rem;
        padding: 1.25rem 0;
        border-top: 1px solid #e9ecef;
    }
    
    .cta-section.cta-secondary .cta-content {
        text-align: center;
    }
    
    .cta-section.cta-secondary h2 {
        color: #333;
        font-size: 1.5rem;
        margin-bottom: 0;
    }
    
    /* Estilos para los popups personalizados */
    .custom-popup {
        padding: 5px;
    }
    
    .custom-popup h3 {
        margin-top: 0;
        margin-bottom: 8px;
        color: #003366;
        font-size: 16px;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 5px;
    }
    
    .popup-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .popup-badge-success {
        background-color: #00e676;
        color: #003300;
    }
    
    .popup-badge-warning {
        background-color: #ff9800;
        color: #663300;
    }
    
    .popup-details {
        font-size: 13px;
        color: #333;
    }
    
    .popup-details p {
        margin: 5px 0;
        line-height: 1.4;
    }
    
    .popup-details i {
        margin-right: 5px;
        color: #FF6B00;
    }
    
    /* Estilo para el mensaje de carga del viento */
    .wind-loading-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        z-index: 1000;
        text-align: center;
        min-width: 200px;
    }
    
    .wind-loading-message i {
        margin-right: 10px;
        color: #FF6B00;
    }
    
    .wind-loading-message button {
        background-color: #FF6B00;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 5px 10px;
        margin-top: 8px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .wind-loading-message button:hover {
        background-color: #e55f00;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Función para actualizar los datos del tiempo
    function refreshWeatherData() {
        const refreshButton = document.getElementById('refresh-weather');
        const weatherTimeElement = document.getElementById('weather-time');
        
        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                // Mostrar estado de carga
                const oldText = refreshButton.innerHTML;
                refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
                refreshButton.disabled = true;
                
                // Realizar la petición a la API
                fetch('/api/weather/refresh')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Actualizar solo los datos del clima sin recargar la página
                            const weatherData = data.data;
                            
                            // Actualizar hora actual
                            if (weatherTimeElement) {
                                weatherTimeElement.textContent = weatherData.current.formatted_time;
                            }
                            
                            // Actualizar datos actuales
                            const currentTemp = document.querySelector('.current-temp');
                            if (currentTemp) {
                                currentTemp.textContent = `${Math.round(weatherData.current.temp)}°C`;
                            }
                            
                            const currentDesc = document.querySelector('.current-description');
                            if (currentDesc) {
                                currentDesc.textContent = weatherData.current.description;
                            }
                            
                            const currentIcon = document.querySelector('.current-icon img');
                            if (currentIcon) {
                                currentIcon.src = `https://openweathermap.org/img/wn/${weatherData.current.icon}@2x.png`;
                                currentIcon.alt = weatherData.current.description;
                            }
                            
                            const currentWind = document.querySelector('.current-detail:nth-child(1) .current-detail-value');
                            if (currentWind) {
                                currentWind.innerHTML = `<i class="fas fa-wind"></i> ${weatherData.current.wind} km/h`;
                            }
                            
                            const currentHumidity = document.querySelector('.current-detail:nth-child(2) .current-detail-value');
                            if (currentHumidity) {
                                currentHumidity.innerHTML = `<i class="fas fa-tint"></i> ${weatherData.current.humidity}%`;
                            }
                            
                            const currentUV = document.querySelector('.current-detail:nth-child(3) .current-detail-value');
                            if (currentUV) {
                                currentUV.innerHTML = `<i class="fas fa-sun"></i> ${weatherData.current.uvi.toFixed(1)}`;
                            }
                            
                            const currentPressure = document.querySelector('.current-detail:nth-child(4) .current-detail-value');
                            if (currentPressure) {
                                currentPressure.innerHTML = `<i class="fas fa-tachometer-alt"></i> ${weatherData.current.pressure} hPa`;
                            }
                            
                            const flightStatus = document.querySelector('.current-flight-status');
                            if (flightStatus) {
                                flightStatus.className = `current-flight-status current-status-${weatherData.current.flight_status}`;
                                const icon = flightStatus.querySelector('i');
                                if (icon) {
                                    icon.className = `fas ${weatherData.current.flight_status === 'optimal' ? 'fa-check-circle' : 
                                                    weatherData.current.flight_status === 'possible' ? 'fa-exclamation-triangle' : 
                                                    weatherData.current.flight_status === 'caution' ? 'fa-exclamation-circle' :
                                                    'fa-times-circle'}`;
                                }
                                flightStatus.innerHTML = flightStatus.innerHTML.replace(flightStatus.textContent.trim(), weatherData.current.status_text);
                            }
                            
                            // Restablecer el botón
                            refreshButton.innerHTML = oldText;
                            refreshButton.disabled = false;
                        } else {
                            // Mostrar error
                            refreshButton.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error al actualizar';
                            setTimeout(() => {
                                refreshButton.innerHTML = oldText;
                                refreshButton.disabled = false;
                            }, 3000);
                        }
                    })
                    .catch(error => {
                        console.error('Error al actualizar datos del tiempo:', error);
                        refreshButton.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error al actualizar';
                        setTimeout(() => {
                            refreshButton.innerHTML = oldText;
                            refreshButton.disabled = false;
                        }, 3000);
                    });
            });
        }
    }
    
    // Accordion functionality
    document.addEventListener('DOMContentLoaded', function() {
        const accordionItems = document.querySelectorAll('.accordion-item');
        
        // Mostrar el primer elemento del acordeón por defecto
        if(accordionItems.length > 0) {
            const firstContent = accordionItems[0].querySelector('.accordion-content');
            const firstIcon = accordionItems[0].querySelector('.accordion-icon');
            firstContent.style.display = 'block';
            firstIcon.textContent = '−';
        }
        
        accordionItems.forEach(item => {
            const header = item.querySelector('.accordion-header');
            const content = item.querySelector('.accordion-content');
            const icon = item.querySelector('.accordion-icon');
            
            // Inicializar los estilos para que funcione correctamente
            content.style.display = content.style.display || 'none';
            
            header.addEventListener('click', () => {
                // Cerrar todos los demás acordeones
                accordionItems.forEach(otherItem => {
                    if (otherItem !== item) {
                        const otherContent = otherItem.querySelector('.accordion-content');
                        const otherIcon = otherItem.querySelector('.accordion-icon');
                        otherContent.style.display = 'none';
                        otherIcon.textContent = '+';
                    }
                });
                
                // Alternar el estado del acordeón actual
                content.style.display = content.style.display === 'block' ? 'none' : 'block';
                icon.textContent = icon.textContent === '+' ? '−' : '+';
                
                // Desplazar suavemente a la posición del acordeón
                if (content.style.display === 'block') {
                    setTimeout(() => {
                        header.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            });
        });
        
        // Initialize Mapbox map
        mapboxgl.accessToken = 'pk.eyJ1IjoiNDIwYnRjIiwiYSI6ImNtOTN3ejBhdzByNjgycHF6dnVmeHl2ZTUifQ.Utq_q5wN6DHwpkn6rcpZdw';
        
        // Coordenadas de Málaga (Ubicación central)
        const malagaCoordinates = [-4.4214, 36.7213];
        
        // Estilos disponibles para el mapa
        const mapStyles = {
            satellite: 'mapbox://styles/mapbox/satellite-streets-v12',
            streets: 'mapbox://styles/mapbox/streets-v12'
        };
        
        // Estado actual del mapa
        let currentMapStyle = 'satellite';
        
        // Crear el mapa con vista satelital
        const map = new mapboxgl.Map({
            container: 'map',
            style: mapStyles.satellite, // Estilo de satélite con calles
            center: malagaCoordinates,
            zoom: 9,
            attributionControl: false
        });
        
        // Añadir controles de navegación
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
        
        // Añadir atribución personalizada
        map.addControl(new mapboxgl.AttributionControl({
            compact: true
        }));
        
        // Definir los puntos de servicio
        const serviceAreas = [
            { name: 'Málaga Capital', coordinates: [-4.4214, 36.7213], description: 'Sede principal', distance: 15, info: 'Centro económico y cultural de la provincia' },
            { name: 'Marbella', coordinates: [-4.8862, 36.5092], description: 'Servicio completo', distance: 48, info: 'Destino turístico de lujo en la Costa del Sol' },
            { name: 'Fuengirola', coordinates: [-4.6248, 36.5394], description: 'Servicio completo', distance: 18, info: 'Popular destino de playa con ambiente familiar' },
            { name: 'Benalmádena', coordinates: [-4.5162, 36.5951], description: 'Servicio completo', distance: 8, info: 'Conocida por su puerto deportivo y parque de atracciones' },
            { name: 'Torremolinos', coordinates: [-4.4986, 36.6225], description: 'Servicio completo', distance: 0, info: 'Base de operaciones principal con disponibilidad inmediata' },
            { name: 'Nerja', coordinates: [-3.8768, 36.7446], description: 'Servicio bajo demanda', distance: 65, info: 'Famosa por sus cuevas y acantilados impresionantes' },
            { name: 'Estepona', coordinates: [-5.1466, 36.4277], description: 'Servicio bajo demanda', distance: 70, info: 'Ciudad costera con encanto andaluz tradicional' },
            { name: 'Ronda', coordinates: [-5.1675, 36.7429], description: 'Servicio bajo demanda', distance: 85, info: 'Impresionante ciudad de montaña con vistas panorámicas' },
            { name: 'Rincón de la Victoria', coordinates: [-4.2773, 36.7172], description: 'Servicio completo', distance: 22, info: 'Zona residencial con hermosas playas' },
            { name: 'Antequera', coordinates: [-4.5633, 37.0192], description: 'Servicio bajo demanda', distance: 52, info: 'Ciudad histórica con impresionante patrimonio' }
        ];
        
        // Esperar a que el mapa cargue
        map.on('load', function() {
            // Se eliminó el marcador del dron sobre Málaga como solicitado
            
            // Añadir un control personalizado para cambiar el estilo del mapa
            const mapStyleControl = document.createElement('div');
            mapStyleControl.className = 'map-style-control';
            
            const mapStyleButton = document.createElement('button');
            mapStyleButton.className = 'map-style-btn';
            mapStyleButton.innerHTML = '<i class="fas fa-layer-group"></i>';
            mapStyleButton.title = 'Cambiar vista del mapa';
            mapStyleButton.addEventListener('click', function() {
                // Cambiar entre los estilos
                currentMapStyle = currentMapStyle === 'satellite' ? 'streets' : 'satellite';
                map.setStyle(mapStyles[currentMapStyle]);
                
                // Esperar a que el estilo se cargue para restaurar los marcadores y capas
                map.once('style.load', function() {
                    // Intentar añadir la capa de viento después de cambiar el estilo
                    if (windLayerActive) {
                        addWindLayer();
                    }
                });
            });
            
            mapStyleControl.appendChild(mapStyleButton);
            document.getElementById('map').appendChild(mapStyleControl);
            
            // Control para la capa de viento
            const windLayerControl = document.createElement('div');
            windLayerControl.className = 'wind-layer-control';
            
            const windLayerButton = document.createElement('button');
            windLayerButton.className = 'wind-layer-btn';
            windLayerButton.innerHTML = '<i class="fas fa-wind"></i>';
            windLayerButton.title = 'Mostrar/ocultar capa de viento';
            
            // Estado de la capa de viento
            let windLayerActive = false;
            let windLayerLoading = false; // Indicador de carga
            
            windLayerButton.addEventListener('click', function() {
                // Si está en proceso de carga, no hacemos nada para evitar problemas
                if (windLayerLoading) {
                    return;
                }
                
                if (windLayerActive) {
                    // Si está activa, la quitamos inmediatamente
                    windLayerActive = false;
                    windLayerButton.classList.remove('wind-active');
                    removeWindLayer();
                } else {
                    // Si no está activa, mostramos mensaje de carga
                    windLayerLoading = true;
                    windLayerButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    windLayerButton.title = 'Cargando capa de viento...';
                    
                    // Crear mensaje de carga visible en el mapa
                    const loadingMessage = document.createElement('div');
                    loadingMessage.className = 'wind-loading-message';
                    loadingMessage.innerHTML = `
                        <div><i class="fas fa-spinner fa-spin"></i> Cargando datos del viento actuales...</div>
                        <button id="cancel-wind-loading">Cancelar</button>
                    `;
                    document.getElementById('map').appendChild(loadingMessage);
                    
                    // Agregar funcionalidad al botón de cancelar
                    document.getElementById('cancel-wind-loading').addEventListener('click', function() {
                        // Eliminar mensaje de carga
                        loadingMessage.remove();
                        
                        // Restaurar botón
                        windLayerButton.innerHTML = '<i class="fas fa-wind"></i>';
                        windLayerButton.title = 'Mostrar capa de viento';
                        windLayerLoading = false;
                    });
                    
                    // Usamos setTimeout para permitir que la UI se actualice antes de iniciar
                    // la operación pesada, así el usuario ve el mensaje de carga
                    setTimeout(() => {
                        // Añadir la capa
                        windLayerActive = true;
                        addWindLayer();
                        
                        // Eliminar mensaje de carga
                        if (document.contains(loadingMessage)) {
                            loadingMessage.remove();
                        }
                        
                        // Restaurar el botón
                        windLayerButton.innerHTML = '<i class="fas fa-wind"></i>';
                        windLayerButton.title = 'Ocultar capa de viento';
                        windLayerButton.classList.add('wind-active');
                        windLayerLoading = false;
                    }, 100);
                }
            });
            
            windLayerControl.appendChild(windLayerButton);
            document.getElementById('map').appendChild(windLayerControl);
            
            // Función para añadir la capa de viento con animación
            function addWindLayer() {
                console.time('Generación de capa de viento');
                try {
                    // Eliminar la capa y fuente existentes si las hay
                    removeWindLayer();
                    
                    // Obtener los datos de viento de la API del tiempo
                    // Aquí usamos los datos del clima que ya tenemos en la página
                    const windSpeed = {{ weather_data.current.wind|default(10) }}; // Velocidad en km/h
                    const windDirection = {{ weather_data.current.wind_deg|default(45) }}; // Dirección en grados
                    
                    // Determinar el color del viento según la velocidad - Colores más vibrantes
                    let windColor;
                    if (windSpeed < 15) {
                        windColor = '#00E676'; // Verde vibrante para vientos suaves (0-15 km/h)
                    } else if (windSpeed < 35) {
                        windColor = '#FF9800'; // Naranja vibrante para vientos moderados (15-34 km/h)
                    } else {
                        windColor = '#FF1744'; // Rojo vibrante para vientos fuertes (>35 km/h)
                    }
                    
                    // Ajustar la visualización - Mayor grosor y opacidad como solicitado
                    const opacity = Math.min(0.9, 0.6 + (windSpeed / 100)); // Mayor opacidad
                    const width = 1.5; // Grosor fijo de 1.5px como solicitado
                    
                    // Enfoque mejorado: Usar cuadrícula local en lugar de global
                    // Generar líneas solo para el área de Málaga y alrededores
                    const malageaBounds = [
                        [-5.5, 36.2], // Suroeste de la provincia
                        [-3.5, 37.5]  // Noreste de la provincia
                    ];
                    
                    const gridSize = 30; // Número de puntos en cada dirección (aún más denso)
                    const cellSizeX = (malageaBounds[1][0] - malageaBounds[0][0]) / gridSize;
                    const cellSizeY = (malageaBounds[1][1] - malageaBounds[0][1]) / gridSize;
                    
                    // Calcular componentes de viento basados en dirección y velocidad
                    // Invertimos los ángulos para que apunten correctamente en la dirección DEL viento (no HACIA donde va)
                    const windRadians = ((windDirection + 180) % 360) * Math.PI / 180;
                    
                    // Hacemos que las flechas sean más largas y claras en la dirección
                    const windX = Math.sin(windRadians) * (windSpeed / 15); // Mayor escala para mejor visibilidad
                    const windY = Math.cos(windRadians) * (windSpeed / 15);
                    
                    // Líneas más largas para que la dirección sea más clara
                    const lineLength = Math.min(Math.max(windSpeed / 6, 0.2), 0.6);
                    
                    const windPoints = [];
                    
                    // Reducimos drásticamente la cantidad de líneas para mejorar el rendimiento y visibilidad
                    const optimizedGridSize = 12; // Menor cantidad de líneas para no saturar la vista
                    const stepX = cellSizeX * (gridSize / optimizedGridSize);
                    const stepY = cellSizeY * (gridSize / optimizedGridSize);
                    
                    // Crear líneas de viento en forma de flecha para indicar dirección
                    for (let i = 0; i < optimizedGridSize; i++) {
                        for (let j = 0; j < optimizedGridSize; j++) {
                            const lng = malageaBounds[0][0] + i * stepX + (Math.random() * stepX * 0.3);
                            const lat = malageaBounds[0][1] + j * stepY + (Math.random() * stepY * 0.3);
                            
                            // Crear línea principal en dirección del viento
                            const endLng = lng + windX * lineLength;
                            const endLat = lat + windY * lineLength;
                            
                            // Ángulo para las "colas" de la flecha
                            const arrowSize = lineLength * 0.3; // Tamaño de las colas de la flecha
                            const arrowAngle1 = windRadians - Math.PI / 6; // 30 grados
                            const arrowAngle2 = windRadians + Math.PI / 6; // 30 grados
                            
                            // Componentes de las colas de la flecha
                            const arrow1X = Math.sin(arrowAngle1) * arrowSize;
                            const arrow1Y = Math.cos(arrowAngle1) * arrowSize;
                            const arrow2X = Math.sin(arrowAngle2) * arrowSize;
                            const arrow2Y = Math.cos(arrowAngle2) * arrowSize;
                            
                            // Punto de inicio y final (línea principal)
                            windPoints.push({
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'LineString',
                                    'coordinates': [
                                        [lng, lat],
                                        [endLng, endLat]
                                    ]
                                },
                                'properties': {
                                    'speed': windSpeed,
                                    'direction': windDirection,
                                    'type': 'main'
                                }
                            });
                            
                            // Colas de la flecha para indicar dirección
                            windPoints.push({
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'LineString',
                                    'coordinates': [
                                        [endLng, endLat],
                                        [endLng + arrow1X, endLat + arrow1Y]
                                    ]
                                },
                                'properties': {
                                    'speed': windSpeed,
                                    'direction': windDirection,
                                    'type': 'arrow'
                                }
                            });
                            
                            windPoints.push({
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'LineString',
                                    'coordinates': [
                                        [endLng, endLat],
                                        [endLng + arrow2X, endLat + arrow2Y]
                                    ]
                                },
                                'properties': {
                                    'speed': windSpeed,
                                    'direction': windDirection,
                                    'type': 'arrow'
                                }
                            });
                        }
                    }
                    
                    // Añadir la fuente de datos
                    map.addSource('wind-data', {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': windPoints
                        }
                    });
                    
                    // Añadir la capa de líneas con animación
                    map.addLayer({
                        'id': 'wind-lines',
                        'type': 'line',
                        'source': 'wind-data',
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round',
                            'visibility': 'visible' // Asegurar que sea visible
                        },
                        'paint': {
                            'line-color': windColor, // Color según velocidad
                            'line-width': width, // Ancho de 1px aprox como solicitado
                            'line-opacity': opacity, // Opacidad basada en velocidad
                            'line-dasharray': [0, 4, 3], // Patrón para animar
                        }
                    });
                    
                    // Animar las líneas de viento con movimiento más pronunciado
                    let animationOffset = 0;
                    const animateWind = () => {
                        if (!map.getLayer('wind-lines')) {
                            // Si la capa fue eliminada, detener la animación
                            return;
                        }
                        
                        // Incremento más rápido para movimiento más notorio
                        animationOffset = (animationOffset + 1.5) % 20; // Ciclo más largo y rápido
                        
                        // Patrón más dinámico para la animación
                        map.setPaintProperty('wind-lines', 'line-dasharray', [
                            0,
                            5 - (animationOffset / 6), // Mayor variación para movimiento más visible
                            2 + (animationOffset / 4)
                        ]);
                        
                        windAnimationId = requestAnimationFrame(animateWind);
                    };
                    
                    // Iniciar la animación y guardar su ID para poder detenerla después
                    windAnimationId = requestAnimationFrame(animateWind);
                    
                    // Manejar zoom y movimiento del mapa para que las líneas se actualicen
                    map.on('zoom', updateWindOnZoom);
                    map.on('move', updateWindOnZoom);
                    
                    console.timeEnd('Generación de capa de viento');
                    console.log('Capa de viento añadida con éxito - Color: ' + windColor + ', Dirección: ' + windDirection + '°');
                } catch (error) {
                    console.error('Error al añadir capa de viento:', error);
                }
            }
            
            // Variable para guardar el ID de la animación
            let windAnimationId = null;
            
            // Actualizar líneas de viento al hacer zoom o mover el mapa
            function updateWindOnZoom() {
                if (windLayerActive) {
                    // Solo actualizar si el viento está activo y la capa existe
                    if (map.getLayer('wind-lines')) {
                        // Actualizar la opacidad para mantener la visualización constante en diferentes niveles de zoom
                        const zoomLevel = map.getZoom();
                        const adjustedOpacity = Math.min(0.8, 0.3 + (zoomLevel / 15));
                        map.setPaintProperty('wind-lines', 'line-opacity', adjustedOpacity);
                    }
                }
            }
            
            // Función para eliminar la capa de viento y detener su animación
            function removeWindLayer() {
                // Detener la animación si existe
                if (windAnimationId) {
                    cancelAnimationFrame(windAnimationId);
                    windAnimationId = null;
                }
                
                // Eliminar eventos de zoom y movimiento
                map.off('zoom', updateWindOnZoom);
                map.off('move', updateWindOnZoom);
                
                // Eliminar capa y fuente
                if (map.getLayer('wind-lines')) {
                    map.removeLayer('wind-lines');
                }
                
                if (map.getSource('wind-data')) {
                    map.removeSource('wind-data');
                }
            }
            
            // Añadir marcadores para cada área de servicio
            serviceAreas.forEach(area => {
                // Saltamos Málaga Capital, la dejamos en la lista pero sin marcador en el mapa
                if (area.name === 'Málaga Capital') {
                    return;
                }
                
                // Crear elemento para el marcador personalizado (tamaño ajustado)
                const markerElement = document.createElement('div');
                markerElement.className = 'custom-marker';
                markerElement.style.backgroundImage = `url('${window.location.origin}/static/img/icons/service-marker.svg')`;
                markerElement.style.backgroundSize = 'cover';
                markerElement.style.width = '20px'; // 18px + 10% = ~20px
                markerElement.style.height = '30px'; // 27px + 10% = ~30px
                
                // Crear popup para el marcador con información detallada
                const popup = new mapboxgl.Popup({
                    offset: 15, // Ajustado para el nuevo tamaño
                    closeButton: false,
                    maxWidth: '280px' // Ancho máximo para mejor legibilidad
                }).setHTML(`
                    <div class="custom-popup">
                        <h3>${area.name}</h3>
                        <div class="popup-badge ${area.description.includes('completo') ? 'popup-badge-success' : 'popup-badge-warning'}">
                            ${area.description}
                        </div>
                        <div class="popup-details">
                            <p><i class="fas fa-info-circle"></i> ${area.info}</p>
                            <p><i class="fas fa-road"></i> <strong>Distancia desde Torremolinos:</strong> ${area.distance} km</p>
                        </div>
                    </div>
                `);
                
                // Coordenadas ajustadas para las distintas áreas
                let adjustedCoords = [...area.coordinates];
                
                // Ajustes específicos para cada localidad para centrar mejor los iconos
                if (area.name === 'Rincón de la Victoria') {
                    adjustedCoords = [-4.2773, 36.7222]; // Ajustado para mejor posición
                } else if (area.name === 'Antequera') {
                    adjustedCoords = [-4.5633, 37.0212]; // Ajustado para mejor posición
                } else if (area.name === 'Marbella') {
                    adjustedCoords = [-4.8862, 36.5122]; // Ajustado para mejor posición
                } else if (area.name === 'Torremolinos') {
                    adjustedCoords = [-4.4986, 36.6245]; // Ajustado para mejor posición
                }
                
                // Añadir marcador al mapa
                new mapboxgl.Marker(markerElement)
                    .setLngLat(adjustedCoords)
                    .setPopup(popup)
                    .addTo(map);
            });
        });
        
        // Manejar clic en las áreas de servicio para mover el mapa
        document.querySelectorAll('.service-areas li').forEach((item, index) => {
            item.addEventListener('click', () => {
                const areaName = item.textContent.trim();
                const area = serviceAreas.find(a => a.name === areaName);
                
                if (area) {
                    map.flyTo({
                        center: area.coordinates,
                        zoom: 13,
                        essential: true
                    });
                }
            });
            
            // Hacer que los elementos de la lista sean interactivos visualmente
            item.style.cursor = 'pointer';
            item.addEventListener('mouseenter', () => {
                item.style.color = '#FF6B00';
            });
            item.addEventListener('mouseleave', () => {
                item.style.color = '';
            });
        });
        
        // Inicializar la funcionalidad de actualización del tiempo
        refreshWeatherData();
        
        // El manejador del formulario de contacto se ha movido a script.js para evitar envíos duplicados
    });
</script>
{% endblock %}
